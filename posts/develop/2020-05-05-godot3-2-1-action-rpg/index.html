<!DOCTYPE html>
<html lang="zh-cn"><head>
  <meta charset="UTF-8">
  <style type="text/css">
    :root .footer > #box[style="width:100%;height:100%;position:fixed;top:0"],
    :root .btn.btn-default.hotwords[target="_blank"],
    :root .error > #qqs,
    :root .content > a > .topline,
    :root .container > a.mid-wrapper,
    :root .container > .pic_container,
    :root .container > .ads
    { display: none !important; }</style>  
  <link crossorigin="anonymous" media="all"
        rel="stylesheet"
        href="https://yantree.github.io/style/css/frameworks.css" />
  <link crossorigin="anonymous" media="all"
        rel="stylesheet" href="https://yantree.github.io/style/css/github.css" />  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>「Godot」ARPG 实例</title>
  <link rel="icon" type="image/x-icon" class="js-site-favicon" href="https://yantree.github.io/style/favicon.ico">
  <meta name="theme-color" content="#1e2327">
  

  <script crossorigin="anonymous"
  type="application/javascript" src="https://yantree.github.io/style/js/compat-bootstrap.js"></script>
  <script crossorigin="anonymous"
  type="application/javascript" src="https://yantree.github.io/style/js/environment-bootstrap.js"></script>
  <script crossorigin="anonymous"
  type="application/javascript" src="https://yantree.github.io/style/js/vendor.js"></script>  
  <script crossorigin="anonymous"
          type="application/javascript" src="https://yantree.github.io/style/js/frameworks.js"></script>

  <script crossorigin="anonymous" async="async"
          type="application/javascript" src="https://yantree.github.io/style/js/github-bootstrap.js"></script>
          

          
</head>
<body class="env-production emoji-size-boost page-responsive page-profile"><div class="position-relative js-header-wrapper">
  <a href="#start-of-content" class="p-3 bg-blue text-white show-on-focus js-skip-to-content">Skip to content</a>
  <span class="Progress progress-pjax-loader position-fixed width-full js-pjax-loader-bar">
    <span class="progress-pjax-loader-bar top-0 left-0" style="width: 0%;"></span>
  </span>

  
  <header class="Header js-details-container Details flex-wrap flex-lg-nowrap p-responsive" role="banner">

    
    <div class="Header-item d-none d-lg-flex">
      <a class="Header-link" href="https://yantree.github.io/" aria-label="Homepage" data-ga-click="Header, go to dashboard, icon:logo">
        <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true">
          <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
        </svg>
      </a>
    </div>

    
    <div class="Header-item d-lg-none">
      <button class="Header-link btn-link js-details-target" type="button" aria-label="Toggle navigation" aria-expanded="false">
        <svg height="24" class="octicon octicon-three-bars" viewBox="0 0 12 16" version="1.1" width="18" aria-hidden="true"><path fill-rule="evenodd" d="M11.41 9H.59C0 9 0 8.59 0 8c0-.59 0-1 .59-1H11.4c.59 0 .59.41.59 1 0 .59 0 1-.59 1h.01zm0-4H.59C0 5 0 4.59 0 4c0-.59 0-1 .59-1H11.4c.59 0 .59.41.59 1 0 .59 0 1-.59 1h.01zM.59 11H11.4c.59 0 .59.41.59 1 0 .59 0 1-.59 1H.59C0 13 0 12.59 0 12c0-.59 0-1 .59-1z"></path></svg>
      </button>
    </div>

    
    <div class="Header-item Header-item--full flex-column flex-lg-row width-full flex-order-2 flex-lg-order-none mr-0 mr-lg-3 mt-3 mt-lg-0 Details-content--hidden">

      
      <div class="header-search flex-self-stretch flex-lg-self-auto mr-0 mr-lg-3 mb-3 mb-lg-0 scoped-search site-scoped-search js-site-search position-relative js-jump-to" role="combobox" aria-owns="jump-to-results" aria-label="Search or jump to" aria-haspopup="listbox" aria-expanded="false">
        <div class="position-relative">
        </div>
      </div>

            
      <nav class="d-flex flex-column flex-lg-row flex-self-stretch flex-lg-self-auto" aria-label="Global">
        <a class="js-selected-navigation-item Header-link  mr-0 mr-lg-3 py-2 py-lg-0 border-top border-lg-top-0 border-white-fade-15" data-hotkey="g p" data-ga-click="Header, click, Nav menu - item:home context:user" aria-label="Pull requests you created" data-selected-links="/pulls /pulls/assigned /pulls/mentioned /pulls" href="https://yantree.github.io/">
          Home
        </a>
        <a class="js-selected-navigation-item Header-link  mr-0 mr-lg-3 py-2 py-lg-0 border-top border-lg-top-0 border-white-fade-15" data-hotkey="g i" data-ga-click="Header, click, Nav menu - item:gallery context:user" aria-label="Issues you created" data-selected-links="/issues /issues/assigned /issues/mentioned /issues" href="https://yantree.github.io/other_pages/gallery/">
          Gallery
        </a>



        <a class="js-selected-navigation-item Header-link  mr-0 mr-lg-3 py-2 py-lg-0 border-top border-lg-top-0 border-white-fade-15" data-ga-click="Header, click, Nav menu - item:about" data-selected-links="/explore /trending /trending/developers /integrations /integrations/feature/code /integrations/feature/collaborate /integrations/feature/ship showcases showcases_search showcases_landing /explore" href="#">
          
        </a>
</nav>


</div>
<div class="Header-item Header-item--full flex-justify-center d-lg-none position-relative" style="margin-right: auto;">
  <a class="Header-link" href="https://yantree.github.io/" aria-label="Homepage" data-ga-click="Header, go to dashboard, icon:logo">
    <svg class="octicon octicon-mark-github v-align-middle" height="32" viewBox="0 0 16 16" version="1.1" width="32" aria-hidden="true">
      <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
    </svg>
  </a>
</div>



<div class="Header-item mr-0 mr-lg-3 flex-order-1 flex-lg-order-none">
  <a aria-label="Send me an email" href="mailto:yanshudream@outlook.com" class="Header-link notification-indicator position-relative tooltipped tooltipped-sw js-socket-channel js-notification-indicator" data-hotkey="g n" data-ga-click="Header, go to notifications, icon:read" data-channel="notification-changed:42629243">
    <span class="js-indicator-modifier mail-status "></span>
    <svg class="octicon octicon-mail" viewBox="0 0 16 16" version="1.1" width="32" height="32" aria-hidden="true"><path fill-rule="evenodd" d="M0 4v8c0 .55.45 1 1 1h12c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1H1c-.55 0-1 .45-1 1zm13 0L7 9 1 4h12zM1 5.5l4 3-4 3v-6zM2 12l3.5-3L7 10.5 8.5 9l3.5 3H2zm11-.5l-4-3 4-3v6z"></path></svg>
  </a>
</div>
</header>
</div>
<div id="js-flash-container">


    <template class="js-flash-template">
      <div class="flash flash-full  js-flash-template-container">
    <div class="container-xl px-2">
      <button class="flash-close js-flash-close" type="button" aria-label="Dismiss this message">
        <svg class="octicon octicon-x" viewBox="0 0 12 16" version="1.1" width="12" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.48 8l3.75 3.75-1.48 1.48L6 9.48l-3.75 3.75-1.48-1.48L4.52 8 .77 4.25l1.48-1.48L6 6.52l3.75-3.75 1.48 1.48L7.48 8z"></path></svg>
      </button>
      
        <div class="js-flash-template-message"></div>
  
    </div>
  </div>
    </template>
  </div><div id="content">
<div class="application-main " data-commit-hovercards-enabled="">
  <div itemscope="" itemtype="http://schema.org/SoftwareSourceCode" class="">
    <main id="js-repo-pjax-container" data-pjax-container="">
      <div class="pagehead repohead instapaper_ignore readability-menu experiment-repo-nav pt-0 pt-lg-4 ">
        <div class="repohead-details-container clearfix container-lg p-responsive d-none d-lg-block">
          <div class="mb-3 d-flex">
            <h1 class="public css-truncate float-none flex-auto width-fit pl-0">
              <a class="avatar mr-1">
                <img
                  src="https://avatars3.githubusercontent.com/u/42629243?s=60&u=4c15c4c420106664f4020caa794ccfc78a762ece&v=4" width="26" height="26">
              </a>
              <span class="author"><a
                                     href="https://yantree.github.io/">YanTree</a></span>
              <span class="path-divider">/</span>
              <strong itemprop="name" class="css-truncate-target" style="max-width: 410px"><a
                                                                                             href="https://yantree.github.io/posts/develop/2020-05-05-godot3-2-1-action-rpg/">「Godot」ARPG 实例</a></strong>

              <div class="d-block text-small text-gray">
                Created <time-ago datetime="2020-05-05" class="no-wrap"
                                  title="Created at 2020/05/05">
                  2020-05-05</time-ago>
                <span class="file-info-divider"></span>
                Modifyed <time-ago datetime="2020-05-05" class="no-wrap"
                                   title="Modified  at 2020/05/05">
                  2020-05-05</time-ago>
              </div>
            </h1>
          </div>
        </div>




      </div>
      <div class="container-lg clearfix new-discussion-timeline experiment-repo-nav  p-responsive">
        <div class="repository-content ">
          <div class="Box mt-3 position-relative">
            <div class="Box-header py-2 d-flex flex-column flex-shrink-0 flex-md-row flex-md-items-center">
              <div class="text-mono f6 flex-auto pr-3 flex-order-2 flex-md-order-1 mt-2 mt-md-0">
                7165 Words
                
              </div>
            </div>

            <div id="readme" class="Box-body readme blob instapaper_body js-code-block-container">
              <article class="markdown-body entry-content p-3 p-md-6" itemprop="text"><h1 id="action-rpg-实战">Action RPG 实战</h1>
<p>整个项目教程由 <strong><a href="https://www.youtube.com/watch?v=mAbG8Oi-SvQ&amp;list=PL9FzW-m48fn2SlrW0KoLT4n5egNdX-W9a">本杰明</a></strong> 师傅制作，项目的资源在本杰明师傅的 <strong><a href="https://github.com/uheartbeast/youtube-tutorials/blob/master/Action%20RPG/Action%20RPG%20Resources.zip">Github</a></strong> 账号里。</p>
<!-- raw HTML omitted -->
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#action-rpg-%E5%AE%9E%E6%88%98">Action RPG 实战</a>
<ul>
<li><a href="#1delta--smooth-move">1，Delta + Smooth move</a>
<ul>
<li><a href="#delta">Delta</a></li>
<li><a href="#smooth-move">Smooth move</a></li>
</ul>
</li>
<li><a href="#2collisions--move_and_slide">2，Collisions + move_and_slide</a>
<ul>
<li><a href="#collisions">collisions</a></li>
<li><a href="#move_and_slide">move_and_slide</a></li>
</ul>
</li>
<li><a href="#3scenes--ysort">3，Scenes + ysort</a>
<ul>
<li><a href="#scenes">scenes</a></li>
<li><a href="#ysort">ysort</a></li>
</ul>
</li>
<li><a href="#4animationplayer">4，AnimationPlayer</a></li>
<li><a href="#5animationtree">5，AnimationTree</a></li>
<li><a href="#6background-grass--dirt-path-autotile">6，Background Grass + Dirt Path Autotile</a>
<ul>
<li><a href="#background-grass">background grass</a></li>
<li><a href="#autotile">autotile</a></li>
</ul>
</li>
<li><a href="#7collision-with-autotiles">7，Collision with autotiles</a></li>
<li><a href="#8attack-animation--state-marhes">8，Attack Animation + State Marhes</a></li>
<li><a href="#9signals--instancing-scenes-in-code">9，Signals + Instancing Scenes in Code</a>
<ul>
<li><a href="#_process-%E5%92%8C--physics_process-%E7%9A%84%E6%AF%94%E8%BE%83"><code>_process</code> 和 <code>-physics_process</code> 的比较</a>
<ul>
<li><a href="#%E7%9B%B8%E5%90%8C">相同</a></li>
<li><a href="#%E4%B8%8D%E5%90%8C">不同</a></li>
</ul>
</li>
<li><a href="#animationsprite-%E5%92%8C-animationplayer"><code>AnimationSprite</code> 和 <code>AnimationPlayer</code></a></li>
<li><a href="#signals">Signals</a></li>
<li><a href="#instancing-scenes-in-code">Instancing Scenes in Code</a></li>
</ul>
</li>
<li><a href="#10melee-attacks-with-hurtboxes-and-hitboxes">10，Melee Attacks with Hurtboxes and Hitboxes</a>
<ul>
<li><a href="#%E6%80%9D%E8%B7%AF%EF%BC%9A">思路：</a></li>
<li><a href="#%E6%96%B0%E9%97%AE%E9%A2%98">新问题</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95">解决方法</a></li>
<li><a href="#%E6%96%B0%E7%9A%84%E6%8E%A2%E8%AE%A8">新的探讨</a></li>
<li><a href="#%E8%A7%A3">解</a></li>
</ul>
</li>
<li><a href="#11roll-state">11，Roll State</a></li>
<li><a href="#12knockback--enemy-bat">12，Knockback + Enemy Bat</a></li>
<li><a href="#13enemy-stats--export-variables--setget">13，Enemy Stats + Export Variables + Setget</a></li>
<li><a href="#14enemy-death-effect--bug-fix">14，Enemy Death Effect + Bug Fix</a>
<ul>
<li><a href="#bug">Bug</a></li>
<li><a href="#death-effect">death effect</a></li>
</ul>
</li>
<li><a href="#15bat-ai-start">15，Bat AI Start</a>
<ul>
<li><a href="#hit-animate">hit animate</a></li>
<li><a href="#ai-start">AI start</a>
<ul>
<li><a href="#%E5%88%9B%E5%BB%BA%E4%BE%A6%E5%AF%9F%E5%8C%BA%E5%9F%9F">创建侦察区域</a></li>
<li><a href="#bat-%E7%9A%84%E4%B8%89%E4%B8%AA%E7%8A%B6%E6%80%81">bat 的三个状态</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#16player-status--enemy-attack">16，Player Status + Enemy Attack</a>
<ul>
<li><a href="#%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98">出现的问题</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF">解决思路</a></li>
</ul>
</li>
<li><a href="#17player-hearts-ui">17，Player Hearts UI</a>
<ul>
<li><a href="#control-node">Control Node</a></li>
<li><a href="#texturerect">TextureRect</a>
<ul>
<li><a href="#code">code</a></li>
</ul>
</li>
<li><a href="#%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98">遇到的问题</a></li>
</ul>
</li>
<li><a href="#18enemy-soft-collisions">18，Enemy Soft Collisions</a></li>
<li><a href="#19player-camera">19，Player Camera</a>
<ul>
<li><a href="#%E8%AE%A9-camera-%E7%A7%BB%E5%8A%A8%E6%9B%B4%E5%8A%A0%E5%B9%B3%E6%BB%91">让 Camera 移动更加平滑</a></li>
<li><a href="#%E5%B0%86%E6%98%BE%E7%A4%BA%E7%94%9F%E5%91%BD%E5%80%BC%E7%8A%B6%E6%80%81%E7%9A%84%E5%9B%BA%E5%AE%9A%E5%9C%A8-camera-%E7%9A%84%E5%B7%A6%E4%B8%8A%E8%A7%92">将显示生命值状态的♥固定在 Camera 的左上角</a></li>
<li><a href="#%E4%BF%AE%E5%A4%8D%E8%A7%92%E8%89%B2%E6%AD%BB%E4%BA%A1%E6%97%B6camera-%E5%9B%9E%E5%88%B0%E8%A7%92%E8%89%B2%E5%88%9D%E5%A7%8B%E4%BD%8D%E7%BD%AE%E7%9A%84-bug">修复角色死亡时，Camera 回到角色初始位置的 BUG</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<!-- raw HTML omitted -->
<h2 id="1delta--smooth-move">1，Delta + Smooth move</h2>
<h3 id="delta">Delta</h3>
<p><code>delta</code> 其实是一个数值，等于游戏从上一帧到下一帧的 ==时间差==，基本是固定不变的 <code>1/60</code></p>
<h3 id="smooth-move">Smooth move</h3>
<p>本质还是使用上面的 <code>delta</code> 。引擎默认以 ==1pixel== 为单位递增进行移动，<code>1 pixel * delta</code> 大幅缩小递增单位，以此让角色的移动更平滑。</p>
<ul>
<li><strong>1 pixel</strong></li>
</ul>
<figure style="margin:1rem 0.5rem"><a href="../../../img/../../../img/godot/action-rpg/gotdot_piex_movetest.png" title="gotdot_piex_movetest.png"><img src="../../../img/../../../img/godot/action-rpg/gotdot_piex_movetest.png" alt="gotdot_piex_movetest.png" width=""></a></figure>

<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">KinematicBody2D</span>

<span style="color:#66d9ef">var</span> velocity <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO

<span style="color:#66d9ef">func</span> _physics_process(delta):
    <span style="color:#66d9ef">var</span> input_vector <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO
    input_vector<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_right&#34;</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_left&#34;</span>)
    input_vector<span style="color:#f92672">.</span>y <span style="color:#f92672">=</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_down&#34;</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_up&#34;</span>)

    <span style="color:#66d9ef">if</span> input_vector <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO:
        velocity <span style="color:#f92672">=</span> input_vector
    <span style="color:#66d9ef">else</span>
        velocity <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO

    velocity <span style="color:#f92672">=</span> move_and_collide(velocity)

</code></pre></td></tr></table>
</div>
</div><ul>
<li><strong>1 pixel * delta</strong></li>
</ul>
<figure style="margin:1rem 0.5rem"><a href="../../../img/../../../img/godot/action-rpg/gotdot_smooth-move.png" title="gotdot_smooth-move.png"><img src="../../../img/../../../img/godot/action-rpg/gotdot_smooth-move.png" alt="gotdot_smooth-move.png" width=""></a></figure>

<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">KinematicBody2D</span>

<span style="color:#66d9ef">const</span> ACCELERATION <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>
<span style="color:#66d9ef">const</span> MAX_SPEED <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>
<span style="color:#66d9ef">const</span> FRICTION <span style="color:#f92672">=</span> <span style="color:#ae81ff">25</span>

<span style="color:#66d9ef">var</span> velocity <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO

<span style="color:#66d9ef">func</span> _physics_process(delta):
    <span style="color:#66d9ef">var</span> input_vector <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO
    input_vector<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_right&#34;</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_left&#34;</span>)
    input_vector<span style="color:#f92672">.</span>y <span style="color:#f92672">=</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_down&#34;</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_up&#34;</span>)
    input_vector<span style="color:#f92672">=</span> input_vector<span style="color:#f92672">.</span>normalized() <span style="color:#75715e"># keep the same speed move 45 degree</span>

    <span style="color:#66d9ef">if</span> input_vector <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO:
        velocity <span style="color:#f92672">+=</span> input_vector <span style="color:#f92672">*</span> ACCELERATION <span style="color:#f92672">*</span> delta <span style="color:#75715e"># base delta&#39;s acceleration</span>
        velocity <span style="color:#f92672">=</span> velocity<span style="color:#f92672">.</span>clamped(MAX_SPEED <span style="color:#f92672">*</span> delta)  <span style="color:#75715e"># base delta&#39;s to restrict highest speed</span>
    <span style="color:#66d9ef">else</span>:
        velocity <span style="color:#f92672">=</span> velocity<span style="color:#f92672">.</span>move_toward(<span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO, FRICTION) <span style="color:#75715e"># smooth stop animation</span>

    move_and_collide(velocity)

</code></pre></td></tr></table>
</div>
</div><h2 id="2collisions--move_and_slide">2，Collisions + move_and_slide</h2>
<h3 id="collisions">collisions</h3>
<p>碰撞器 <code>节点</code> ，godot 2D 里有两类 <code>CollisionShape2D</code> + <code>CollisionPolygon2D</code></p>
<h3 id="move_and_slide">move_and_slide</h3>
<p>上面图片里最后一行代码使用的是 <code>move_and_collide</code> 移动并检测是否碰撞的方法，该方法并不适合用来 <code>控制角色</code> 的移动，碰撞之后会立刻停止当角色移动至角落时，角色会不停的 <code>sticky</code> ，要解决这个问题，我们要使用 <code>move_and_slide</code> 方法，当碰撞发生时，同时让角色的移动更加 <code>slide</code> 。</p>
<p>替换后的代码：</p>
<figure style="margin:1rem 0.5rem"><a href="../../../img/../../../img/godot/action-rpg/collision_slide.png" title="collision_slide.png"><img src="../../../img/../../../img/godot/action-rpg/collision_slide.png" alt="collision_slide.png" width=""></a></figure>

<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">KinematicBody2D</span>

<span style="color:#66d9ef">const</span> ACCELERATION <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>
<span style="color:#66d9ef">const</span> MAX_SPEED <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>
<span style="color:#66d9ef">const</span> FRICTION <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>

<span style="color:#66d9ef">var</span> velocity <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO

<span style="color:#66d9ef">func</span> _physics_process(delta):
    <span style="color:#66d9ef">var</span> input_vector <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO
    input_vector<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_right&#34;</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_left&#34;</span>)
    input_vector<span style="color:#f92672">.</span>y <span style="color:#f92672">=</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_down&#34;</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_up&#34;</span>)
    input_vector<span style="color:#f92672">=</span> input_vector<span style="color:#f92672">.</span>normalized() <span style="color:#75715e"># keep the same speed move 45 degree</span>

    <span style="color:#66d9ef">if</span> input_vector <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO:
        velocity <span style="color:#f92672">=</span> velocity<span style="color:#f92672">.</span>move_toward(input_vector <span style="color:#f92672">*</span> MAX_SPEED, ACCELERATION <span style="color:#f92672">*</span> delta)
    <span style="color:#66d9ef">else</span>:
        velocity <span style="color:#f92672">=</span> velocity<span style="color:#f92672">.</span>move_toward(<span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO, FRICTION) <span style="color:#75715e"># smooth stop animation</span>

    velocity <span style="color:#f92672">=</span> velocity<span style="color:#f92672">.</span>move_toward(<span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO, FRICTION) <span style="color:#75715e"># smooth stop animation</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="3scenes--ysort">3，Scenes + ysort</h2>
<h3 id="scenes">scenes</h3>
<p>godot 的一个核心设计理念就是基于 <code>节点式</code> 的设计，你创建的每一个 <code>*.tscn</code> 文件的本质就是创建了一个节点，这是一个非常优雅、powerful 的设计</p>
<h3 id="ysort">ysort</h3>
<p>ysort 是一个 2D <code>节点</code> ，作用如其名，在垂直方向上对节点重新排序</p>
<ul>
<li><strong>without ysort</strong></li>
</ul>
<figure style="margin:1rem 0.5rem"><a href="../../../img/../../../img/godot/action-rpg/without_ysort.png" title="without_ysort.png"><img src="../../../img/../../../img/godot/action-rpg/without_ysort.png" alt="without_ysort.png" width=""></a></figure>

<ul>
<li><strong>with ysort</strong></li>
</ul>
<figure style="margin:1rem 0.5rem"><a href="../../../img/../../../img/godot/action-rpg/with_ysort.png" title="with_ysort.png"><img src="../../../img/../../../img/godot/action-rpg/with_ysort.png" alt="with_ysort.png" width=""></a></figure>

<blockquote>
<p>​    🏷   ysort 基于节点 ==世界坐标==  Y 的 方向，在之前先调整好各个节点的 <code>Sprite</code> 和 <code>CollisionShape2D</code> 的中心位置至世界坐标。</p>
</blockquote>
<hr>
<h2 id="4animationplayer">4，AnimationPlayer</h2>
<p><code>官方介绍：</code> Container and player of Animation resources</p>
<figure style="margin:1rem 0.5rem"><a href="../../../img/../../../img/godot/action-rpg/animationplayer.png" title="animationplayer.png"><img src="../../../img/../../../img/godot/action-rpg/animationplayer.png" alt="animationplayer.png" width=""></a></figure>

<p>用于设置游戏角色的各种动画， 说得明白点就是角色的 <!-- raw HTML omitted -->⬆<!-- raw HTML omitted -->  <!-- raw HTML omitted -->⬇<!-- raw HTML omitted -->  <!-- raw HTML omitted -->⬅<!-- raw HTML omitted -->  <!-- raw HTML omitted -->➡<!-- raw HTML omitted -->  以及  <!-- raw HTML omitted -->jump<!-- raw HTML omitted --> <!-- raw HTML omitted -->attach<!-- raw HTML omitted --> 等各种角色会用到的动画。当然不止主角会用到这个节点，<code>怪物</code> 也可以使用该节点使得怪物也更加生动。</p>
<blockquote>
<p><code>AnimationPlayer</code> 是一个功能非常强大的节点，它可以给同层级的所有子节点的所有属性设置关键帧</p>
</blockquote>
<hr>
<h2 id="5animationtree">5，AnimationTree</h2>
<p><code>官方介绍</code>：&hellip;&hellip;好像没有</p>
<p>这是一个用于混合上面 <code>AnimationPlayer</code> 里的各种动画，通过一些代码将动画绑定在对应的 <!-- raw HTML omitted -->kbd<!-- raw HTML omitted --> 的节点。这个节点大大减少了代码工作量，以前为了判断角色当前的状态，需要大量的 <code>if if if if if ......</code> 语句，没完没了，使用 <code>AnimationTree</code> 节点则会减少大量的代码，在这就不举例了。</p>
<h2 id="6background-grass--dirt-path-autotile">6，Background Grass + Dirt Path Autotile</h2>
<h3 id="background-grass">background grass</h3>
<p>制作 <code>background</code> 可以使用   ==Sprite==  或者  ==TextureRect==  节点，但是 TextureRect 节点是 <code>Ctrl</code> 类节点，不推荐使用。如果想把 background 作为一块 <code>tile</code> 来使用的话，需要把 <code>import</code> 目录下的 <code>Repeat</code> 设置为 ==enable== 最后 <code>Reimport</code> 一下。</p>
<blockquote>
<p>使用 <code>Sprite</code> 节点要用到的属性有 <code>Region</code> ，在 output 栏里切换至 <code>Texture Region</code> 在这里就可以调整 background 的大小了。如果勾选了 Offset 里的 <code>Centered</code> 属性，就要调整一下 <code>Transform</code> 里的 position 位置了</p>
</blockquote>
<hr>
<h3 id="autotile">autotile</h3>
<p>没整明白，需要研究研究怎么使用的</p>
<h2 id="7collision-with-autotiles">7，Collision with autotiles</h2>
<p><code>TileMap</code> 节点里如果选择使用 autotile，会有一个 <code>Collision</code> 面板，用于绘制碰撞检测范围</p>
<figure style="margin:1rem 0.5rem"><a href="../../../img/../../../img/godot/action-rpg/autotile_collision.png" title="autotile_collision.png"><img src="../../../img/../../../img/godot/action-rpg/autotile_collision.png" alt="autotile_collision.png" width=""></a></figure>

<h2 id="8attack-animation--state-marhes">8，Attack Animation + State Marhes</h2>
<p>主要是在 <code>AnimationPlayer</code> 节点里添加了四个不同方向的 <code>attack</code> 动画，使用枚举 <code>enum</code> 抽象角色的三个状态( MOVE, ROLL, ATTACK )，用 <code>gdscript</code> 里的 <code>match</code> 方法来 case。</p>
<p><strong>state marhes code</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#75715e"># 枚举的三个状态（默认从0开始匹配）</span>
<span style="color:#66d9ef">enum</span> {
    MOVE,   <span style="color:#75715e"># -&gt; 用0指代 MOVE</span>
    ROLL,   <span style="color:#75715e"># -&gt; 用1指代 ROLL</span>
    ATTACK  <span style="color:#75715e"># -&gt; 用2指代 ATTACK</span>
}

<span style="color:#75715e"># 设置初始/默认状态</span>
<span style="color:#66d9ef">var</span> state <span style="color:#f92672">=</span> MOVE

<span style="color:#75715e"># process 方法</span>
<span style="color:#66d9ef">func</span> _physics_process(delta):
    match state:
        MOVE:
            move_state(delta)

        ROLL:
            <span style="color:#66d9ef">pass</span>

        ATTACK:
            attack_state(delta)

<span style="color:#75715e"># MOVE 状态的函数</span>
<span style="color:#66d9ef">func</span> move_state(delta):
    <span style="color:#66d9ef">var</span> input_vector <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO
    input_vector<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_right&#34;</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_left&#34;</span>)
    input_vector<span style="color:#f92672">.</span>y <span style="color:#f92672">=</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_down&#34;</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_up&#34;</span>)
    input_vector<span style="color:#f92672">=</span> input_vector<span style="color:#f92672">.</span>normalized()

    <span style="color:#66d9ef">if</span> input_vector <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO:
        animationTree<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#34;parameters/Idle/blend_position&#34;</span>, input_vector)
        animationTree<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#34;parameters/Run/blend_position&#34;</span>, input_vector)
        animationTree<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#34;parameters/Attack/blend_position&#34;</span>, input_vector)
        animationState<span style="color:#f92672">.</span>travel(<span style="color:#e6db74">&#34;Run&#34;</span>)
        velocity <span style="color:#f92672">=</span> velocity<span style="color:#f92672">.</span>move_toward(input_vector <span style="color:#f92672">*</span> MAX_SPEED, ACCELERATION <span style="color:#f92672">*</span> delta)
    <span style="color:#66d9ef">else</span>:
        animationState<span style="color:#f92672">.</span>travel(<span style="color:#e6db74">&#34;Idle&#34;</span>)
        velocity <span style="color:#f92672">=</span> velocity<span style="color:#f92672">.</span>move_toward(<span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO, FRICTION) <span style="color:#75715e"># smooth stop animation</span>

    velocity <span style="color:#f92672">=</span> move_and_slide(velocity)

    <span style="color:#75715e"># 从 MOVE 状态中切换至 ATTACK 状态</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>is_action_just_pressed(<span style="color:#e6db74">&#34;Attack&#34;</span>):
        state <span style="color:#f92672">=</span> ATTACK

<span style="color:#75715e"># ATTACK 状态的函数</span>
<span style="color:#66d9ef">func</span> attack_state(delta):
    velocity <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO  <span style="color:#75715e"># 避免 MOVE 状态的动画在 ATTACK 动画残留</span>
    animationState<span style="color:#f92672">.</span>travel(<span style="color:#e6db74">&#34;Attack&#34;</span>)

<span style="color:#75715e"># 一个踩坑点，attack 动画结束后，应立即调整 state，不然角色就冻结在 attack 动画的最后一帧上</span>
<span style="color:#75715e"># 该函数添加在 AnimationPlayer 节点 attack 动画最后一帧上(add track → call method...)</span>
<span style="color:#66d9ef">func</span> attack_animation_finished():
    state <span style="color:#f92672">=</span> MOVE
</code></pre></td></tr></table>
</div>
</div><h2 id="9signals--instancing-scenes-in-code">9，Signals + Instancing Scenes in Code</h2>
<h3 id="_process-和--physics_process-的比较"><code>_process</code> 和 <code>-physics_process</code> 的比较</h3>
<h4 id="相同">相同</h4>
<p>Called during the processing step of the main loop。</p>
<h4 id="不同">不同</h4>
<p><code>_process</code>  Processing happens at every frame and as fast as possible，所以 <code>delta</code>  的值不恒定。</p>
<p><code>-physics_process</code>  Physics processing means that the frame rate is synced to the physics，所以 <code>delta</code> 值应该是恒定的。</p>
<h3 id="animationsprite-和-animationplayer"><code>AnimationSprite</code> 和 <code>AnimationPlayer</code></h3>
<p><code>AnimationSprite</code> 适用于制作简单动画的节点，不需要 blend 动画，这里创建小草消失的动画就用的 AnimationSprite。</p>
<p><code>AnimationPlayer</code> 适用于创建复杂动画的节点，需要 blend 动画，这里为了便于实现角色的移动、攻击、翻滚动画之间的控制和切换，就一起使用了 <code>AnimationPlayer</code> <code>AnimationTree</code> 两个节点。</p>
<h3 id="signals">Signals</h3>
<figure style="margin:1rem 0.5rem"><a href="../../../img/../../../img/godot/action-rpg/signal.png" title="signal.png"><img src="../../../img/../../../img/godot/action-rpg/signal.png" alt="signal.png" width=""></a></figure>

<p>如图一个 signal 的实例，子节点 Animated Sprite 发出一个 signal 给 GrassEffect 父节点。signal 的意思就相当于你告诉你的朋友们你恋爱了，对象是谁谁谁。Source 就是你，你发出 signal ——你找对象了，对象是谁，Target 就是你的朋友们，朋友们知道你恋爱了，对象是谁。</p>
<h3 id="instancing-scenes-in-code">Instancing Scenes in Code</h3>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#75715e"># 这里是为了实例化 GrassEffect。当角色 Attack Grass 时，给 Grass 添加一个消失的动画。</span>
<span style="color:#75715e"># 因为 GrassEffect.tscn 不能像 Grass.tscn 直接拖拽进游戏运行的场景里，不然游戏运行的场景就一直播放 GrassEffect.tscn 草消失的效果，所以只能在代码里进行实例化 GrassEffect。</span>

<span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Node2D</span>

<span style="color:#66d9ef">func</span> _process(delta):
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>is_action_just_pressed(<span style="color:#e6db74">&#34;Attack&#34;</span>):
        <span style="color:#66d9ef">var</span> GrassEffect <span style="color:#f92672">=</span> load(<span style="color:#e6db74">&#34;res://Effects/GrassEffect.tscn&#34;</span>) <span style="color:#75715e"># 载入需要实例化的 scene</span>
        <span style="color:#66d9ef">var</span> grassEffect <span style="color:#f92672">=</span> GrassEffect<span style="color:#f92672">.</span>instance() <span style="color:#75715e"># 实例化 scene，此时未载入游戏场景里</span>
        <span style="color:#66d9ef">var</span> world <span style="color:#f92672">=</span> get_tree()<span style="color:#f92672">.</span>current_scene     <span style="color:#75715e"># 获取当前 scene 的根节点</span>
        world<span style="color:#f92672">.</span>add_child(grassEffect)             <span style="color:#75715e"># 当前游戏场景里添加要实例化的 scene</span>

        <span style="color:#75715e"># 以上4行代码就完成了 scene 的实例化，你应该学到是在任何单独的 *.tscn 文件里，实例化任何地方 scene</span>

        <span style="color:#75715e"># 将草消失动画的位置放在每一个实例化后的 Grass.tscn 位置上，global_position 的值就是当前 scene 的位置</span>
        grassEffect<span style="color:#f92672">.</span>global_position <span style="color:#f92672">=</span> global_position
        queue_free()

</code></pre></td></tr></table>
</div>
</div><h2 id="10melee-attacks-with-hurtboxes-and-hitboxes">10，Melee Attacks with Hurtboxes and Hitboxes</h2>
<h3 id="思路">思路：</h3>
<ol>
<li>
<p>为每一个需要碰撞检测的 scene 添加一个基于 <code>CollisionShape2D</code> 的 <code>Area2D</code> 节点，因为该节点可以发出被碰撞的 <code>signal</code>，也有很多其他有用的 signals。</p>
</li>
<li>
<p>使用 <code>AnimationPlayer</code> 为碰撞检测的 <code>CollisionShape2D</code> 节点设置关键帧，控制其 <code>Disabled</code> 和 <code>Enable</code> 。以达到使用 <code>Attack</code> 时，进行碰撞检测，移动时，就 disable，不检测。</p>
</li>
</ol>
<blockquote>
<p>补充：为了更方便的控制 Player 的 Hitbox，将 Position2D 节点作为其父节点。Positon2D 建立了一个独立的坐标系统，以 Position2D 节点的位置作为子节点的世界原点。</p>
</blockquote>
<hr>
<h3 id="新问题">新问题</h3>
<p>由于 <code>Area2D</code> 被碰撞就会发出 signal ，执行对应方法的特殊性。当两块草地紧挨在一起的时候，他们就会一起执行对应的方法，草地会一起消失，这可能会使游戏出现一些 BUG。说得更容易理解一点就是，如果是在飞机大战之类的游戏里的话，友军相互碰撞的话，就会出现攻击 友军 的行为。</p>
<h3 id="解决方法">解决方法</h3>
<p>在 <code>项目设置</code> 里，设置对应的 <code>Layer Names</code> ，这又是一套用于碰撞检测的系统，你可能会很疑惑了。在每一个可以设置 <code>Collision</code> 属性的节点里，可以设置该节点的 <code>Layer</code> <code>Mask</code> ，它们的值全来源你在项目设置里面设置的各个 Layers 的名字，Layer 的值是该节点自身所处的 Layer，Mask 的值是该节点寻找的 Layer。</p>
<h3 id="新的探讨">新的探讨</h3>
<p><code>Bush</code> <code>Grass</code> 两个 scene 都用到了碰撞检测，为什么角色可以从 Grass 上穿过，却不能从 Bush 上穿过？</p>
<h3 id="解">解</h3>
<p>Bush 节点的根节点是 <code>StaticBody2D</code> 节点，而 Grass 节点的根节点是 <code>Node2D</code> 节点。 <code>StaticBody2D</code> 节点是自带有 Collision 物理属性的，而 <code>Grass</code> 节点是没有的。而且在使用 StaticBody2D 节点时，添加碰撞检测节点 (可以是 <code>CollisionShape2D</code>) 是必要的。所以如果在新建的场景里直接添加碰撞检测节点的，角色都会与之碰撞而不是穿过。</p>
<h2 id="11roll-state">11，Roll State</h2>
<ol>
<li>和之前添加 <code>Idle</code> <code>Attack</code> <code>Run</code> 动画一样，分别添加四个方向上的 <code>Roll</code> 动画。</li>
<li>在 <code>AnimationTree</code> 新建一个 <code>Add BlendSpace2D</code> 节点，添加 transition，编辑这个节点。</li>
<li>添加代码控制角色。</li>
</ol>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span></span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">KinematicBody2D</span>

<span style="color:#66d9ef">const</span> ACCELERATION <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>
<span style="color:#66d9ef">const</span> MAX_SPEED <span style="color:#f92672">=</span> <span style="color:#ae81ff">90</span>
<span style="color:#66d9ef">const</span> FRICTION <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>
<span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#66d9ef">const</span> ROLL_SPEED <span style="color:#f92672">=</span> <span style="color:#ae81ff">120</span>
</span>
<span style="color:#66d9ef">enum</span> {
    MOVE,
    ROLL,
    ATTACK
}

<span style="color:#66d9ef">var</span> state <span style="color:#f92672">=</span> MOVE
<span style="color:#66d9ef">var</span> velocity <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO
<span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#66d9ef">var</span> roll_vector <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>DOWN
</span>
<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> animationPlayer <span style="color:#f92672">=</span> <span style="color:#f92672">$</span><span style="color:#a6e22e">AnimationPlayer</span>
<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> animationTree <span style="color:#f92672">=</span> <span style="color:#f92672">$</span>AnimationTree
<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> animationState <span style="color:#f92672">=</span> animationTree<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;parameters/playback&#34;</span>)

<span style="color:#66d9ef">func</span> _ready():
    animationTree<span style="color:#f92672">.</span>active <span style="color:#f92672">=</span> true

<span style="color:#66d9ef">func</span> _physics_process(delta):
    match state:
        MOVE:
            move_state(delta)

<span style="display:block;width:100%;background-color:#3c3d38">        ROLL:
</span><span style="display:block;width:100%;background-color:#3c3d38">            roll_state(delta)
</span>
        ATTACK:
            attack_state(delta)

<span style="color:#66d9ef">func</span> move_state(delta):
    <span style="color:#66d9ef">var</span> input_vector <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO
    input_vector<span style="color:#f92672">.</span>x <span style="color:#f92672">=</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_right&#34;</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_left&#34;</span>)
    input_vector<span style="color:#f92672">.</span>y <span style="color:#f92672">=</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_down&#34;</span>) <span style="color:#f92672">-</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>get_action_strength(<span style="color:#e6db74">&#34;ui_up&#34;</span>)
    input_vector<span style="color:#f92672">=</span> input_vector<span style="color:#f92672">.</span>normalized() <span style="color:#75715e"># keep the same speed move 45 degree</span>

    <span style="color:#66d9ef">if</span> input_vector <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO:
<span style="display:block;width:100%;background-color:#3c3d38">        roll_vector <span style="color:#f92672">=</span> input_vector
</span>        animationTree<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#34;parameters/Idle/blend_position&#34;</span>, input_vector)
        animationTree<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#34;parameters/Run/blend_position&#34;</span>, input_vector)
        animationTree<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#34;parameters/Attack/blend_position&#34;</span>, input_vector)
        animationTree<span style="color:#f92672">.</span>set(<span style="color:#e6db74">&#34;parameters/Roll/blend_position&#34;</span>, input_vector)
        animationState<span style="color:#f92672">.</span>travel(<span style="color:#e6db74">&#34;Run&#34;</span>)
        velocity <span style="color:#f92672">=</span> velocity<span style="color:#f92672">.</span>move_toward(input_vector <span style="color:#f92672">*</span> MAX_SPEED, ACCELERATION <span style="color:#f92672">*</span> delta)
    <span style="color:#66d9ef">else</span>:
        animationState<span style="color:#f92672">.</span>travel(<span style="color:#e6db74">&#34;Idle&#34;</span>)
        velocity <span style="color:#f92672">=</span> velocity<span style="color:#f92672">.</span>move_toward(<span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO, FRICTION) <span style="color:#75715e"># smooth stop animation</span>

<span style="display:block;width:100%;background-color:#3c3d38">    move()
</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>is_action_just_pressed(<span style="color:#e6db74">&#34;roll&#34;</span>):
        state <span style="color:#f92672">=</span> ROLL

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">Input</span><span style="color:#f92672">.</span>is_action_just_pressed(<span style="color:#e6db74">&#34;Attack&#34;</span>):
        state <span style="color:#f92672">=</span> ATTACK

<span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#66d9ef">func</span> move():
</span><span style="display:block;width:100%;background-color:#3c3d38">    velocity <span style="color:#f92672">=</span> move_and_slide(velocity)
</span>
<span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#66d9ef">func</span> roll_state(delta):
</span><span style="display:block;width:100%;background-color:#3c3d38">    velocity <span style="color:#f92672">=</span> roll_vector <span style="color:#f92672">*</span> ROLL_SPEED
</span><span style="display:block;width:100%;background-color:#3c3d38">    animationState<span style="color:#f92672">.</span>travel(<span style="color:#e6db74">&#34;Roll&#34;</span>)
</span><span style="display:block;width:100%;background-color:#3c3d38">    move()
</span>
<span style="color:#66d9ef">func</span> attack_state(delta):
    velocity <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO
    animationState<span style="color:#f92672">.</span>travel(<span style="color:#e6db74">&#34;Attack&#34;</span>)

<span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#66d9ef">func</span> roll_animation_finished():
</span><span style="display:block;width:100%;background-color:#3c3d38">    velocity <span style="color:#f92672">=</span> velocity <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.8</span>
</span><span style="display:block;width:100%;background-color:#3c3d38">    state <span style="color:#f92672">=</span> MOVE
</span>
<span style="color:#66d9ef">func</span> attack_animation_finished():
    state <span style="color:#f92672">=</span> MOVE

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Roll 还是稍微不同于 Attack 动画的，roll 和 move 类似，需要一个 Vector2 向量存储向量坐标</p>
</blockquote>
<hr>
<h2 id="12knockback--enemy-bat">12，Knockback + Enemy Bat</h2>
<p>主要是为 <code>Bat</code> 添加一个击退效果，角色朝那个方向前进，bat 就往哪个方向后退。困惑的地方可能就是 Bat 节点和 bat 子节点 Hurtbox collision 属性的 Layer，Mask 的设置，以及 Player 子节点 Hitbox collison 属性的 Layer，Mask 的设置了。</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="center">Layer</th>
<th align="center">Mask</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">Bat</td>
<td align="center">Enemy</td>
<td align="center">World</td>
</tr>
<tr>
<td align="left">Bat  -&gt;  Hurtbox</td>
<td align="center">EnemyHurtbox</td>
<td align="center"></td>
</tr>
<tr>
<td align="left">Player</td>
<td align="center">Player</td>
<td align="center">World</td>
</tr>
<tr>
<td align="left">Player  -&gt;  Hitbox</td>
<td align="center"></td>
<td align="center">EnemyHurtbox</td>
</tr>
</tbody>
</table>
<p><strong>Bat.gd</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">KinematicBody2D</span>

<span style="color:#66d9ef">var</span> knockback <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO

<span style="color:#66d9ef">func</span> _physics_process(delta):
    knockback <span style="color:#f92672">=</span> knockback<span style="color:#f92672">.</span>move_toward(<span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO, <span style="color:#ae81ff">200</span> <span style="color:#f92672">*</span> delta)
    knockback <span style="color:#f92672">=</span> move_and_slide(knockback)

<span style="color:#66d9ef">func</span> _on_Hurtbox_area_entered(area):
    <span style="color:#75715e"># area 这里指的是 Player 节点下的 Hitbox，所以还要再 Hitbox.gd 添加 knockback_vector 变量</span>
    knockback <span style="color:#f92672">=</span> area<span style="color:#f92672">.</span>knockback_vector <span style="color:#f92672">*</span> <span style="color:#ae81ff">140</span>

</code></pre></td></tr></table>
</div>
</div><p><strong>Hitbox.gd</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Area2D</span>

<span style="color:#66d9ef">var</span> knockback_vector <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO

<span style="color:#75715e"># 除此之外还要再 Player.gd 完成 knockback_vector 的初始化设置，及赋值</span>
</code></pre></td></tr></table>
</div>
</div><p><strong>Player.gd</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#75715e"># 将SwordHitbox 载入 swordHitbox 变量中</span>
<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> swordHitbox <span style="color:#f92672">=</span> <span style="color:#f92672">$</span>HitboxPivot<span style="color:#f92672">/</span>SwordHitbox

<span style="color:#66d9ef">func</span> _ready():
    <span style="color:#f92672">...</span>
    <span style="color:#75715e"># 设置一开始 Bat knockback 的初始值，玩家一开始的朝向</span>
    swordHitbox<span style="color:#f92672">.</span>knockback_vector <span style="color:#f92672">=</span> roll_vector

<span style="color:#66d9ef">func</span> move_state(delta):
    <span style="color:#f92672">...</span>
    <span style="color:#66d9ef">if</span> input_vector <span style="color:#f92672">!=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO:
        roll_vector <span style="color:#f92672">=</span> input_vector
        <span style="color:#75715e"># 完成 knockback_vector 的赋值</span>
        swordHitbox<span style="color:#f92672">.</span>knockback_vector <span style="color:#f92672">=</span> input_vector
        <span style="color:#f92672">...</span>
    <span style="color:#f92672">...</span>

<span style="color:#f92672">...</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="13enemy-stats--export-variables--setget">13，Enemy Stats + Export Variables + Setget</h2>
<p><strong>设置 stats</strong></p>
<p>使用 Node 节点，绑定 gdscript 脚本，Node 节点是一个没有世界坐标的特殊节点。Enemy Stats 设置 Enemy 生命值一类的参数，这类节点本身是不需要什么 Sprite ，Area2D 节点，很适合用于存储各类数值参数。</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Node</span>

<span style="color:#66d9ef">export</span> (<span style="color:#a6e22e">int</span>) <span style="color:#66d9ef">var</span> max_health <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>
<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> health <span style="color:#f92672">=</span> max_health <span style="color:#66d9ef">setget</span> set_health

<span style="color:#66d9ef">signal</span> no_health

<span style="color:#66d9ef">func</span> set_health(value):
    health <span style="color:#f92672">=</span> value
    <span style="color:#66d9ef">if</span> health <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>:
        emit_signal(<span style="color:#e6db74">&#34;no_health&#34;</span>)

</code></pre></td></tr></table>
</div>
</div><p>**Export **</p>
<p>上面的代码演示了如何使用 <code>Export</code> 参数，可以很方便的在检视面板里调整参数数值。使用 Export 还有一个好处就是，在实例化节点后，我们可以为同一个参数设置不同的值。例如：同样是 max_health，我们可以在检视面板里将 Bat 的最大值设置为 3，Grass 的最大值设置为 1，真的非常方便。在实例化后，为了确保我们设置的 max_health 最大值为检视里的值，写 <code>var health = max_health</code> 是不行的，它读取的是 stats 脚本里 max_health 的值，我们需要这样写 <code>onready var health = max_health</code> 这样 max_health 读取的是我们在检视面板里设置的值。</p>
<p><strong>Setget</strong></p>
<p>这里只是用了 set 方法，没有使用 get 方法。上面 setget 的意思是，每一次 health 值的改动，都要调用 set_health 方法。这样做就不用在每一帧里检查 health 值是否为 0。</p>
<p><strong>继承特定script</strong></p>
<p>在 <code>extend</code> 后面加上要继承的 gdscript 链接</p>
<h2 id="14enemy-death-effect--bug-fix">14，Enemy Death Effect + Bug Fix</h2>
<h3 id="bug">Bug</h3>
<p>角色一开始的位置设置和 roll 的初始方向之间这两者有一个 bug，之间在在检视面板里设置所有动作的初始值</p>
<table>
<thead>
<tr>
<th></th>
<th align="center">x</th>
<th align="center">y</th>
</tr>
</thead>
<tbody>
<tr>
<td>Attack</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
<tr>
<td>Idle</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
<tr>
<td>Roll</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
<tr>
<td>Run</td>
<td align="center">0</td>
<td align="center">1</td>
</tr>
</tbody>
</table>
<p>结果</p>
<figure style="margin:1rem 0.5rem"><a href="../../../img/../../../img/godot/action-rpg/default_position.png" title="default_position.png"><img src="../../../img/../../../img/godot/action-rpg/default_position.png" alt="default_position.png" width=""></a></figure>

<p>除此之外还要设置 <code>var roll_vector = Vector2.DOWN</code> ，这样就解决了这个问题</p>
<h3 id="death-effect">death effect</h3>
<p>改造 <code>Effect.gd</code> 脚本文件，这里我都是采用同一种方式来实现 Grass 消失，Bat 消失的效果——把  PNG 文件拆分成各个小块用作 Frame，需要使用时，直接播放消失动画。所以 <code>Effect.gd</code> 文件具有一定的泛用性。</p>
<p><strong>Code</strong></p>
<p><strong>before</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Node2D</span>

<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> animatedSprite <span style="color:#f92672">=</span> <span style="color:#f92672">$</span><span style="color:#a6e22e">AnimatedSprite</span>

<span style="color:#66d9ef">func</span> _ready():
    animatedSprite<span style="color:#f92672">.</span>frame <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    animatedSprite<span style="color:#f92672">.</span>play(<span style="color:#e6db74">&#34;Animate&#34;</span>)

<span style="color:#66d9ef">func</span> _on_AnimatedSprite_animation_finished():
    queue_free()

</code></pre></td></tr></table>
</div>
</div><p><strong>after</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="display:block;width:100%;background-color:#3c3d38"><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span></span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="display:block;width:100%;background-color:#3c3d38"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">AnimatedSprite</span>
</span>
<span style="color:#66d9ef">func</span> _ready():
<span style="display:block;width:100%;background-color:#3c3d38">    connect(<span style="color:#e6db74">&#34;animation_finished&#34;</span>, self, <span style="color:#e6db74">&#34;_on_animation_finished&#34;</span>)
</span>    frame <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    play(<span style="color:#e6db74">&#34;Animate&#34;</span>)

<span style="color:#66d9ef">func</span> _on_animation_finished():
    queue_free()

</code></pre></td></tr></table>
</div>
</div><p>在这里有应该学会如何在代码里链接 <code>signal</code> ，通过 <code>connect</code> 方法来实现。需要手动链接 signal 的情况目前只有在泛用性脚本里需要用到。</p>
<p><strong>Bat.gd</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">KinematicBody2D</span>

<span style="color:#66d9ef">const</span> EnemyDeathEffect <span style="color:#f92672">=</span> preload(<span style="color:#e6db74">&#34;res://Effects/EnemyDeathEffect.tscn&#34;</span>)

<span style="color:#66d9ef">var</span> knockback <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO

<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> stats <span style="color:#f92672">=</span> <span style="color:#f92672">$</span>Stats

<span style="color:#66d9ef">func</span> _physics_process(delta):
    knockback <span style="color:#f92672">=</span> knockback<span style="color:#f92672">.</span>move_toward(<span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO, <span style="color:#ae81ff">200</span> <span style="color:#f92672">*</span> delta)
    knockback <span style="color:#f92672">=</span> move_and_slide(knockback)

<span style="color:#66d9ef">func</span> _on_Hurtbox_area_entered(area):
    stats<span style="color:#f92672">.</span>health <span style="color:#f92672">-=</span> area<span style="color:#f92672">.</span>damage
    knockback <span style="color:#f92672">=</span> area<span style="color:#f92672">.</span>knockback_vector <span style="color:#f92672">*</span> <span style="color:#ae81ff">130</span>

<span style="color:#66d9ef">func</span> _on_Stats_no_health():
    queue_free()
    <span style="color:#66d9ef">var</span> enemyDeathEffect <span style="color:#f92672">=</span> EnemyDeathEffect<span style="color:#f92672">.</span>instance()
    get_parent()<span style="color:#f92672">.</span>add_child(enemyDeathEffect)
    enemyDeathEffect<span style="color:#f92672">.</span>global_position <span style="color:#f92672">=</span> global_position

</code></pre></td></tr></table>
</div>
</div><h2 id="15bat-ai-start">15，Bat AI Start</h2>
<h3 id="hit-animate">hit animate</h3>
<p>创建一个 HitEffect.tscn 文件，还是使用 <code>AnimatedSprite</code> 节点，因为只是播放一个简单的动画效果。给它绑定昨天写的 Effect.gd 脚本。接着为 Hurtbox 添加一个脚本，用于实例化 HitEffect.tscn。为什么要单独创建 Hurtbox.tscn？这里就是一个原因了，Effect.gd 脚本默认播放场景的动画，它并不决定播还是不播。在这里，我们只想将 hit animate 用于 player 攻击 bat，不想在 attack grass 时也播放该动画，我们可以在 Hurtbox.gd 里创建一个可以 export 的 bool 变量来决定是否播放 hit animate。export 的优点上面已经谈过了，这里就不赘述了。</p>
<h3 id="ai-start">AI start</h3>
<p>这里的 AI 并不那么 AI，bat 的创建其实是和创建 player 一样复杂的，因为 bat 也会 IDLE，CHASE，WANDER 有三种状态，只要是会运动的对象，其实现都是较为复杂的。</p>
<p>这里简单的思路就是，为 bat 添加一个侦察区域，当 player 进入侦察区域时，bat 就会追赶 player；当 player 离开侦察区域时，bat 就停止运动。不理解的话，想想崩坏3rd里，在执行刺杀任务时，对象会有一个红色线框的三角锥区域，进入三角锥就会被对象发现，任务失败。说起来简单，实现起来较为复杂。</p>
<h4 id="创建侦察区域">创建侦察区域</h4>
<p>当然是使用 <code>Area2D</code> 节点啦！再给它添加一个 <code>CollisionShape2D</code> 子节点，用什么形状的碰撞区域，按你自己的喜好来，这里由于是 bat 我们添加一个圆形的碰撞形状。然后将 Area2D collision 属性的 Mask 值设为 Player。</p>
<p><strong>Code</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Area2D</span>

<span style="color:#75715e"># 默认的是没有发现 player</span>
<span style="color:#66d9ef">var</span> player <span style="color:#f92672">=</span> null

<span style="color:#75715e"># 判断是否侦察到 player</span>
<span style="color:#66d9ef">func</span> can_see_player():
    <span style="color:#66d9ef">return</span> player <span style="color:#f92672">!=</span> null

<span style="color:#75715e"># 当 player 进入侦察区域，将 player 对象赋值给 player 变量</span>
<span style="color:#66d9ef">func</span> _on_PlayerDetectionZone_body_entered(body):
    player <span style="color:#f92672">=</span> body

<span style="color:#75715e"># 当 player 离开侦察区域，就是没发现 player</span>
<span style="color:#66d9ef">func</span> _on_PlayerDetectionZone_body_exited(body):
    player <span style="color:#f92672">=</span> null

<span style="color:#75715e"># 这里为什么使用 _body_entered() _body_exited() signal 因为这两个 signal 可以检查不同类型节点的碰撞；_area_entered() _area_exited() 只能检查 Area2D 节点的碰撞</span>
</code></pre></td></tr></table>
</div>
</div><h4 id="bat-的三个状态">bat 的三个状态</h4>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">KinematicBody2D</span>

<span style="color:#75715e"># 实例化侦察区域</span>
<span style="color:#66d9ef">const</span> EnemyDeathEffect <span style="color:#f92672">=</span> preload(<span style="color:#e6db74">&#34;res://Effects/EnemyDeathEffect.tscn&#34;</span>)

<span style="color:#75715e"># 同 Player 一样，我们需要一些数值</span>
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">var</span> ACCELERATION <span style="color:#f92672">=</span> <span style="color:#ae81ff">300</span>
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">var</span> MAX_SPEED <span style="color:#f92672">=</span> <span style="color:#ae81ff">50</span>
<span style="color:#66d9ef">export</span> <span style="color:#66d9ef">var</span> FRICTION <span style="color:#f92672">=</span> <span style="color:#ae81ff">200</span>

<span style="color:#75715e"># 定义 Bat 种状态</span>
<span style="color:#66d9ef">enum</span>{
    IDLE,
    WANDER,
    CHASE
}

<span style="color:#75715e"># bat 初始位置为0</span>
<span style="color:#66d9ef">var</span> velocity <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO
<span style="color:#66d9ef">var</span> knockback <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO

<span style="color:#75715e"># 初始状态为 IDLE</span>
<span style="color:#66d9ef">var</span> state <span style="color:#f92672">=</span> IDLE

<span style="color:#75715e"># 得到 bat 动画节点</span>
<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> sprite <span style="color:#f92672">=</span> <span style="color:#f92672">$</span><span style="color:#a6e22e">AnimatedSprite</span>
<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> stats <span style="color:#f92672">=</span> <span style="color:#f92672">$</span>Stats
<span style="color:#75715e"># 得到侦察区域节点</span>
<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> playerDetectionZone <span style="color:#f92672">=</span> <span style="color:#f92672">$</span>PlayerDetectionZone

<span style="color:#66d9ef">func</span> _physics_process(delta):
    <span style="color:#f92672">......</span>

    <span style="color:#75715e"># 分三种状态</span>
    match state:
        IDLE:
            velocity <span style="color:#f92672">=</span> velocity<span style="color:#f92672">.</span>move_toward(<span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO, FRICTION <span style="color:#f92672">*</span> delta)
            seek_player()
        WANDER:
            <span style="color:#66d9ef">pass</span>

        CHASE:
            <span style="color:#66d9ef">var</span> player <span style="color:#f92672">=</span> playerDetectionZone<span style="color:#f92672">.</span>player
            <span style="color:#66d9ef">if</span> player <span style="color:#f92672">!=</span> null:
                <span style="color:#66d9ef">var</span> direction <span style="color:#f92672">=</span> (player<span style="color:#f92672">.</span>global_position <span style="color:#f92672">-</span> global_position)<span style="color:#f92672">.</span>normalized()
                velocity <span style="color:#f92672">=</span> velocity<span style="color:#f92672">.</span>move_toward(direction <span style="color:#f92672">*</span> MAX_SPEED, ACCELERATION <span style="color:#f92672">*</span> delta)
                <span style="color:#75715e"># 让 bat 正面始终朝向 Player</span>
                sprite<span style="color:#f92672">.</span>flip_h <span style="color:#f92672">=</span> velocity<span style="color:#f92672">.</span>x <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>
            <span style="color:#66d9ef">else</span>:
                <span style="color:#75715e"># Player 离开侦察区域时，切换 bat 状态</span>
                state <span style="color:#f92672">=</span> IDLE

    velocity <span style="color:#f92672">=</span> move_and_slide(velocity)

<span style="color:#75715e"># 查找 Player，分情况返回值</span>
<span style="color:#66d9ef">func</span> seek_player():
    <span style="color:#66d9ef">if</span> playerDetectionZone<span style="color:#f92672">.</span>can_see_player():
        state <span style="color:#f92672">=</span> CHASE

    <span style="color:#f92672">......</span>

</code></pre></td></tr></table>
</div>
</div><h2 id="16player-status--enemy-attack">16，Player Status + Enemy Attack</h2>
<p>给 Player 添加被攻击状态，包括被攻击的特殊效果以及被攻击一定次数后 Player 便会死亡。简单的给 Player.tscn 添加 Hurtbox.tscn，设置碰撞 shape， Bat.tscn 添加 Hitbox.tscn，设置碰撞 shape  就能实现这个功能了。⏰ <strong>记得设置它们两的的 Collision 属性值</strong></p>
<h3 id="出现的问题">出现的问题</h3>
<p>由于是通过碰撞 shape 用于检测 Bat 是否攻击了 Player，当出现 Player 不动时，Bat 的碰撞 shape 比 Player 小，可能 Bat 的碰撞 shape 就一直在 Player 的碰撞 shape 内，结果就是 Bat 一直在攻击 Player 却并没有造成伤害。</p>
<h3 id="解决思路">解决思路</h3>
<p>添加时间计数器，用到了 <code>Timer</code> 节点。这样其实还不够，在 Godot 引擎里，为了解决这一问题，我们还需要设置 hurtbox 的 monitorable 属性。</p>
<p><strong>code</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Area2D</span>

<span style="color:#66d9ef">const</span> HitEffect <span style="color:#f92672">=</span> preload(<span style="color:#e6db74">&#34;res://Effects/HitEffect.tscn&#34;</span>)

<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> timer <span style="color:#f92672">=</span> <span style="color:#f92672">$</span><span style="color:#a6e22e">Timer</span>

<span style="color:#66d9ef">var</span> invincible <span style="color:#f92672">=</span> false <span style="color:#66d9ef">setget</span> set_invincible

<span style="color:#66d9ef">signal</span> invincility_started
<span style="color:#66d9ef">signal</span> invincility_ended

<span style="color:#66d9ef">func</span> set_invincible(value):
    invincible <span style="color:#f92672">=</span> value
    <span style="color:#66d9ef">if</span> invincible <span style="color:#f92672">==</span> true:
        emit_signal(<span style="color:#e6db74">&#34;invincility_started&#34;</span>)
    <span style="color:#66d9ef">else</span>:
        emit_signal(<span style="color:#e6db74">&#34;invincility_ended&#34;</span>)

<span style="color:#66d9ef">func</span> start_invincility(duration):
    self<span style="color:#f92672">.</span>invincible <span style="color:#f92672">=</span> true  <span style="color:#75715e"># 因为使用了 setget，所以要加 self 前缀</span>
    timer<span style="color:#f92672">.</span>start(duration)

<span style="color:#66d9ef">func</span> creat_hit_effect():
    <span style="color:#66d9ef">var</span> hitEffect <span style="color:#f92672">=</span> HitEffect<span style="color:#f92672">.</span>instance()
    <span style="color:#66d9ef">var</span> main <span style="color:#f92672">=</span> get_tree()<span style="color:#f92672">.</span>current_scene
    main<span style="color:#f92672">.</span>add_child(hitEffect)
    hitEffect<span style="color:#f92672">.</span>global_position <span style="color:#f92672">=</span> global_position

<span style="color:#66d9ef">func</span> _on_Timer_timeout():
    self<span style="color:#f92672">.</span>invincible <span style="color:#f92672">=</span> false <span style="color:#75715e"># 因为使用了 setget，所以要加 self 前缀</span>

<span style="color:#66d9ef">func</span> _on_Hurtbox_invincility_ended():
    monitorable <span style="color:#f92672">=</span> true

<span style="color:#66d9ef">func</span> _on_Hurtbox_invincility_started():
    set_deferred(<span style="color:#e6db74">&#34;monitorable&#34;</span>, false)
<span style="color:#75715e"># set_deffered(), monitorable, if true, other monitoring areas can detect this area. 延迟设置，避免 detect 得过快导致了前一次 detect 还没结束，下一次 detect 又来了，保证一次 detect 结束后才下一次 detect。</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="17player-hearts-ui">17，Player Hearts UI</h2>
<h3 id="control-node">Control Node</h3>
<p>这里会用到 control 类节点，<code>Control</code> 和 <code>Label</code> 节点，先用最简单的方法，直接用 text 文本表示角色生命值。</p>
<p><strong>code</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Control</span>

<span style="color:#66d9ef">var</span> hearts <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span> <span style="color:#66d9ef">setget</span> set_hearts
<span style="color:#66d9ef">var</span> max_hearts <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span> <span style="color:#66d9ef">setget</span> set_max_hearts

<span style="color:#66d9ef">onready</span> <span style="color:#66d9ef">var</span> label <span style="color:#f92672">=</span> <span style="color:#f92672">$</span><span style="color:#a6e22e">Label</span>

<span style="color:#66d9ef">func</span> set_hearts(value):
    hearts <span style="color:#f92672">=</span> clamp(value, <span style="color:#ae81ff">0</span>, max_hearts)
    <span style="color:#66d9ef">if</span> label <span style="color:#f92672">!=</span> null:        <span style="color:#75715e"># 刷新 Label 节点里角色生命值数值</span>
        label<span style="color:#f92672">.</span>text <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;HP = &#34;</span> <span style="color:#f92672">+</span> str(hearts)

<span style="color:#66d9ef">func</span> set_max_hearts(value):
    max_hearts <span style="color:#f92672">=</span> max(value, <span style="color:#ae81ff">1</span>)

<span style="color:#66d9ef">func</span> _ready():
    self<span style="color:#f92672">.</span>max_hearts <span style="color:#f92672">=</span> PlayerStats<span style="color:#f92672">.</span>max_health
    self<span style="color:#f92672">.</span>hearts <span style="color:#f92672">=</span> PlayerStats<span style="color:#f92672">.</span>health
    PlayerStats<span style="color:#f92672">.</span>connect(<span style="color:#e6db74">&#34;health_changed&#34;</span>, self, <span style="color:#e6db74">&#34;set_hearts&#34;</span>)

</code></pre></td></tr></table>
</div>
</div><h3 id="texturerect">TextureRect</h3>
<p>使用 TextureRect 节点以使用 texture 作为生命值（对就是用图形表示生命值）。需要两个 TextureRect 节点。一个为 HeartUIEmpty 一个是 HeartUIFull。</p>
<blockquote>
<p>记得勾选 Stretch Mode 属性值下的 Tile</p>
</blockquote>
<h4 id="code">code</h4>
<p><strong>HeartUI.gd</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Node</span>

<span style="color:#66d9ef">export</span> (<span style="color:#a6e22e">int</span>) <span style="color:#66d9ef">var</span> max_health <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">setget</span> set_max_health
<span style="color:#66d9ef">var</span> health <span style="color:#f92672">=</span> max_health <span style="color:#66d9ef">setget</span> set_health

<span style="color:#66d9ef">signal</span> no_health
<span style="color:#66d9ef">signal</span> health_changed(value)
<span style="color:#66d9ef">signal</span> max_health_changed(value)

<span style="color:#66d9ef">func</span> set_max_health(value):
    max_health <span style="color:#f92672">=</span> value
    self<span style="color:#f92672">.</span>health <span style="color:#f92672">=</span> min(health, max_health)
    emit_signal(<span style="color:#e6db74">&#34;max_health_changed&#34;</span>, max_health)

<span style="color:#66d9ef">func</span> set_health(value):
    health <span style="color:#f92672">=</span> value
    emit_signal(<span style="color:#e6db74">&#34;health_changed&#34;</span>, health)
    <span style="color:#66d9ef">if</span> health <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>:
        emit_signal(<span style="color:#e6db74">&#34;no_health&#34;</span>)

<span style="color:#66d9ef">func</span> _ready():
    self<span style="color:#f92672">.</span>health <span style="color:#f92672">=</span> max_health

</code></pre></td></tr></table>
</div>
</div><p><strong>Stats.gd</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Node</span>

<span style="color:#66d9ef">export</span> (<span style="color:#a6e22e">int</span>) <span style="color:#66d9ef">var</span> max_health <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#66d9ef">setget</span> set_max_health
<span style="color:#66d9ef">var</span> health <span style="color:#f92672">=</span> max_health <span style="color:#66d9ef">setget</span> set_health

<span style="color:#66d9ef">signal</span> no_health
<span style="color:#66d9ef">signal</span> health_changed(value)
<span style="color:#66d9ef">signal</span> max_health_changed(value)

<span style="color:#66d9ef">func</span> set_max_health(value):
    max_health <span style="color:#f92672">=</span> value
    self<span style="color:#f92672">.</span>health <span style="color:#f92672">=</span> min(health, max_health)
    emit_signal(<span style="color:#e6db74">&#34;max_health_changed&#34;</span>, max_health)

<span style="color:#66d9ef">func</span> set_health(value):
    health <span style="color:#f92672">=</span> value
    emit_signal(<span style="color:#e6db74">&#34;health_changed&#34;</span>, health)
    <span style="color:#66d9ef">if</span> health <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>:
        emit_signal(<span style="color:#e6db74">&#34;no_health&#34;</span>)

<span style="color:#66d9ef">func</span> _ready():
    self<span style="color:#f92672">.</span>health <span style="color:#f92672">=</span> max_health

</code></pre></td></tr></table>
</div>
</div><h3 id="遇到的问题">遇到的问题</h3>
<p>HeartUIFull.rect.x 的值不能设置为0，在游戏里面，但角色死亡时，还会剩下一格生命值。解决办法很简单，勾选 Texture 属性下的 Expand 属性值就解决这个问题了。</p>
<h2 id="18enemy-soft-collisions">18，Enemy Soft Collisions</h2>
<p>总结一下前面所有内容，发现问题。</p>
<figure style="margin:1rem 0.5rem"><a href="../../../img/../../../img/godot/action-rpg/guess_how_many_bats.png" title="guess_how_many_bats.png"><img src="../../../img/../../../img/godot/action-rpg/guess_how_many_bats.png" alt="guess_how_many_bats.png" width=""></a></figure>

<p>你猜猜上面有几只蝙蝠？其实有三只，这里我们要解决的就是这个问题。</p>
<p>创建一个 SoftCollision.tscn 并且设置它的 collision 属性的 Layer 和 Mask 值都为 SoftCollision。最后给 Bat.tscn 添加这个节点。</p>
<p><strong>code</strong></p>
<p><strong>SoftCollision.gd</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">Area2D</span>

<span style="color:#66d9ef">func</span> is_colliding():
    <span style="color:#66d9ef">var</span> areas <span style="color:#f92672">=</span> get_overlapping_areas()
    <span style="color:#66d9ef">return</span> areas<span style="color:#f92672">.</span>size() <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>

<span style="color:#66d9ef">func</span> get_push_vector():
    <span style="color:#66d9ef">var</span> areas <span style="color:#f92672">=</span> get_overlapping_areas()
    <span style="color:#66d9ef">var</span> push_vector <span style="color:#f92672">=</span> <span style="color:#a6e22e">Vector2</span><span style="color:#f92672">.</span>ZERO
    <span style="color:#66d9ef">if</span> is_colliding():
        <span style="color:#66d9ef">var</span> area <span style="color:#f92672">=</span> areas[<span style="color:#ae81ff">0</span>]
        push_vector <span style="color:#f92672">=</span> area<span style="color:#f92672">.</span>global_position<span style="color:#f92672">.</span>direction_to(global_position)
        push_vector <span style="color:#f92672">=</span> push_vector<span style="color:#f92672">.</span>normalized()
    <span style="color:#66d9ef">return</span> push_vector

</code></pre></td></tr></table>
</div>
</div><p><strong>Bat.gd</strong></p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-gdscript" data-lang="gdscript"><span style="color:#f92672">......</span>

<span style="color:#66d9ef">func</span> _physics_process(delta):
    <span style="color:#f92672">......</span>

    <span style="color:#66d9ef">if</span> softCollison<span style="color:#f92672">.</span>is_colliding():
        velocity <span style="color:#f92672">+=</span> softCollison<span style="color:#f92672">.</span>get_push_vector() <span style="color:#f92672">*</span> delta <span style="color:#f92672">*</span> <span style="color:#ae81ff">400</span>
    velocity <span style="color:#f92672">=</span> move_and_slide(velocity)

<span style="color:#f92672">......</span>

</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>在有很多（&gt;=20）个 chase 对象时，不推荐使用这个方法，该方法会消耗大量资源</p>
</blockquote>
<h2 id="19player-camera">19，Player Camera</h2>
<p>添加一个以角色为中心的 Camera，在 Godot 里面非常简单，只需要在角色节点下添加 <code>Camera</code> 子节点，并且把属性面板里的 Current 属性勾上，就实现了一个最简单 Player Camera 了。</p>
<h3 id="让-camera-移动更加平滑">让 Camera 移动更加平滑</h3>
<p>默认的 Camera 移动看起来特别生硬。在检视面板里开启 <code>Smoothing</code> 属性，还可以改变 <code>Process Mode</code> 的值.</p>
<h3 id="将显示生命值状态的固定在-camera-的左上角">将显示生命值状态的♥固定在 Camera 的左上角</h3>
<p>这种简单方式添加的 Camera， UI 部分并不会固定在 Camera 左上角，随着角色的移动，UI 脱离视线。为节点 <code>HearthUI</code> 添加一个 <code>CanvasLayer</code> 父节点，解决！</p>
<h3 id="修复角色死亡时camera-回到角色初始位置的-bug">修复角色死亡时，Camera 回到角色初始位置的 BUG</h3>
<p>使用这种方式添加的 Camera 就会有这种问题，角色死亡时，Camera 不是在角色死亡的地点，而是回到了角色一开始的位置。解决：将 <code>Camera</code> 节点从 <code>Player</code> 节点里移出来至 Root 目录，在 <code>Player</code> 节点下添加一个 <code>RemoteTransfor2D</code> 子节点，并将其属性设置里的 Remote Path 设置为 <code>Camera</code> 节点，完美解决！</p>
</article>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<div class="utterances"></div>
<script src="https://utteranc.es/client.js"
        repo="YanTree/HUGO_COMMENT"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>


    </div><div class="footer container-xl width-full p-responsive" role="contentinfo">
    <div class="position-relative d-flex flex-row-reverse flex-lg-row flex-wrap flex-lg-nowrap flex-justify-center flex-lg-justify-between pt-6 pb-2 mt-6 f6 text-gray border-top border-gray-light ">
      <ul class="list-style-none d-flex flex-wrap col-12 col-lg-5 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
        <li class="mr-3 mr-lg-0">© 2020 YanTree.</li>
          <li class="mr-3 mr-lg-0"><a href="https://github.com/YanTree/.emacs.d">.emacs.d</a></li>
          <li class="mr-3 mr-lg-0"><a href="#"></a></li>
          <li class="mr-3 mr-lg-0"><a href="http://commonmark.org/help/">Markdown</a></li>
          <li class="mr-3 mr-lg-0"><a href="#"></a></li>
          <li><a href="https://yantree.github.io/other_pages/software/">Software</a></li>
  
      </ul>
  
      <a aria-label="Homepage" title="YanTree&#39;s BLOG" class="footer-octicon d-none d-lg-block mx-lg-4" href="https://yantree.github.io/">
        <svg height="24" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="24" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path></svg>
  </a>
     <ul class="list-style-none d-flex flex-wrap col-12 col-lg-5 flex-justify-center flex-lg-justify-between mb-2 mb-lg-0">
          <li class="mr-3 mr-lg-0"><a href="https://github.com/kasusa/kasusa.github.io">Kasusa</a></li>
          <li class="mr-3 mr-lg-0"><a href="#"></a></li>
        <li class="mr-3 mr-lg-0"><a href="https://yantree.github.io/other_pages/resume/">Resume</a></li>
        <li class="mr-3 mr-lg-0"><a href="#"></a></li>
          <li class="mr-3 mr-lg-0"><a href="https://yantree.github.io/other_pages/about/">About</a></li>
          <li><a href="#"></a></li>
      </ul>
    </div>
    <div class="d-flex flex-justify-center pb-6">
      <span class="f6 text-gray-light"></span>
    </div>
  </div></body>
</html>
